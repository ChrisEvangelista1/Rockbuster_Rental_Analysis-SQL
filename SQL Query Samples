-- Sales by Day (CTE)
WITH cte_payment_period AS (				
	SELECT	date_paid,		
			payment_month,	
			SUM(amount) AS amount_paid	
	FROM (			
		SELECT 	TO_CHAR(payment_date,'mm/dd/yyyy') AS date_paid,	
				payment.amount,
				EXTRACT(MONTH FROM payment_date) AS payment_month
				
		FROM payment		
		)		
	GROUP BY date_paid,payment_month			
	ORDER BY date_paid			
)				
SELECT date_paid,				
		amount_paid AS sales_by_day,		
		SUM(amount_paid) OVER(ORDER BY date_paid) AS rolling_sales,		
		SUM(amount_paid) OVER(PARTITION BY payment_month ORDER BY date_paid) AS rolling_sales_by_month		
FROM cte_payment_period				


-- sales, film count, inventory film count by Category
WITH inventory_by_category AS			
(			
	SELECT 	category.name AS category_name,	
			COUNT(inventory.film_id) AS inventory_film_count
	FROM inventory		
	JOIN film ON film.film_id = inventory.film_id		
	JOIN film_category ON film_category.film_id = film.film_id		
	JOIN category ON category.category_id = film_category.category_id		
	GROUP BY category.name		
	ORDER BY inventory_film_count DESC		
),			
film_count AS			
(			
	SELECT 	category.name AS category_name,	
			COUNT(film.film_id) AS film_count
	FROM film		
	JOIN film_category ON film_category.film_id = film.film_id		
	JOIN category ON category.category_id = film_category.category_id		
	GROUP BY category.name		
	ORDER BY film_count DESC		
),			
sales_by_category AS			
(			
	SELECT	category.name AS category_name,	
			SUM(payment.amount) AS total_sales
	FROM payment		
	JOIN rental ON rental.rental_id = payment.rental_id		
	JOIN inventory ON inventory.inventory_id = rental.inventory_id		
	JOIN film ON film.film_id = inventory.film_id		
	JOIN film_category ON film_category.film_id = film.film_id		
	JOIN category ON category.category_id = film_category.category_id		
	GROUP BY category.name		
)			
SELECT	inventory_by_category.category_name,		
		sales_by_category.total_sales,	
		film_count.film_count,	
		inventory_by_category.inventory_film_count	
FROM inventory_by_category			
JOIN sales_by_category ON sales_by_category.category_name = inventory_by_category.category_name			
JOIN film_count ON film_count.category_name = inventory_by_category.category_name			
ORDER BY total_sales DESC			


-- Top 5 Movies
SELECT 	film.title,	
		category.name,
		SUM(payment.amount) AS total_paid
FROM inventory		
JOIN film ON film.film_id = inventory.film_id		
JOIN film_category ON film_category.film_id = film.film_id		
JOIN category ON category.category_id = film_category.category_id		
JOIN rental ON rental.inventory_id = inventory.inventory_id		
JOIN payment ON payment.rental_id = rental.rental_id		
GROUP BY film.title, category.name, film.rental_rate		
ORDER BY total_paid DESC		
LIMIT 5		

